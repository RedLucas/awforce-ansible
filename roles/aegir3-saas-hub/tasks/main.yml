---
  - name: Figure out the hostmaster root
    shell: "drush @hostmaster status |grep 'Drupal root' |awk '{ print $NF }'"
    register: aegir_siteroot
    sudo: yes
    sudo_user: aegir
    changed_when: False

  - name: Check if custom hostmaster modules are installed
    shell: "[ -d `{{ aegir_siteroot.stdout }}/sites/{{ hostmaster_fqdn }}/modules/hosting_network`]"
    register: aegir_custom_modules_exist
    failed_when: '"found" in aegir_custom_modules_exist.stderr'
    ignore_errors: True
    changed_when: False

  - debug: msg={{ aegir_siteroot.stdoutÂ }}

  - name: Download the SaaS modules from drupal.org
    shell: drush dl -y {{ item }}
    args:
      chdir: '{{ aegir_siteroot.stdout }}/sites/{{ hostmaster_fqdn }}'
    with_items:
      - features
      - hosting_services
      - hosting_variables
      - hosting_saas
      - libraries
      - oauth
      - services
      - services_api_key_auth
    when: aegir_custom_modules_exist|failed
    sudo: yes
    sudo_user: aegir
  # TODO: Download features, enable modules

  - name: Enable the modules
    shell: drush @hostmaster en -y {{ item }}
    with_items:
      - features
      - hosting_network
      - hosting_saas
      - hosting_services
      - hosting_variables
      - libraries
      - oauth
      - oauth_common
      - oauth_common_providerui
      - services
      - services_api_key_auth
    when: aegir_custom_modules_exist|failed
    sudo: yes
    sudo_user: aegir
  # TODO: Download features, enable modules

  - name: Write hosting server import file
    template: src=hosting_network_nodes.json.j2 dest=/tmp/hosting_network_nodes.json owner=aegir group=www-data
