---
  - name: Check if custom hostmaster modules are installed
    shell: "[ -d `/var/aegir/hostmaster-*/sites/{{ inventory_hostname }}/modules/hosting_saas`]"
    failed_when: '"found" in aegir_custom_modules_exist.stderr'
    changed_when: False
    ignore_errors: True
    register: aegir_custom_modules_exist

  # Download the saas modules and enable them.
  # largely based on https://praxis.coop/en/blog/automated-drupal-saas-aegir3
  # When the modules are consolidated we can simplify this a lot.
  # See https://www.drupal.org/node/2698053
  - name: Download the SaaS modules from drupal.org
    shell: drush @hostmaster dl hosting_variables hosting_saas
    when: aegir_custom_modules_exist|failed
    sudo: yes
    sudo_user: aegir
  # TODO: Clone hosting_saas_utils from github
  # TODO: Enable

  # This is not used here, it's used when we aggregate this info on the hub.
  - name: Get credentials for remote authentication
    script: ./generate_credentials.sh
    sudo: yes
    sudo_user: aegir
    changed_when: False
    register: "network_node_credentials"
